@using System.ComponentModel.DataAnnotations

<h5>Contribute to our honeymoon</h5>

@if (Submitted)
{
    <div class="alert alert-success">
        Thank you, @Submission.Name! Your pledge of @Submission.Amount:C has been recorded.
        We'll contact you with details for completing the payment.
    </div>
}
else
{
    <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label class="form-label">Your name</label>
            <InputText class="form-control" @bind-Value="Model.Name" />
        </div>
        <div class="mb-3">
            <label class="form-label">Amount (USD)</label>
            <InputNumber class="form-control" @bind-Value="Model.Amount" />
        </div>
        <div class="mb-3">
            <label class="form-label">Message</label>
            <InputTextArea class="form-control" @bind-Value="Model.Message" />
        </div>
        <div class="mb-3">
            <button class="btn btn-primary" type="submit">Pledge</button>
            <small class="text-muted ms-2">This form records a pledge; integrate Stripe/PayPal for real payments.</small>
        </div>
    </EditForm>
}

@if (Pledges.Any())
{
    <h6 class="mt-4">Pledges</h6>
    <ul class="list-group">
        @foreach (var p in Pledges)
        {
            <li class="list-group-item">
                <strong>@p.Name</strong> pledged @p.Amount:C
                <div class="text-muted small">@p.Message</div>
            </li>
        }
    </ul>

    <div class="mt-3">
        <strong>Total pledged:</strong> @Pledges.Sum(x => x.Amount):C
    </div>
}

@code {
    private SponsorshipModel Model = new();
    private bool Submitted = false;
    private SponsorshipSubmission? Submission;
    private List<SponsorshipSubmission> Pledges = new();

    private Task HandleValidSubmit()
    {
        if (Model.Amount <= 0) return Task.CompletedTask;
        var s = new SponsorshipSubmission
        {
            Name = string.IsNullOrWhiteSpace(Model.Name) ? "Anonymous" : Model.Name,
            Amount = Model.Amount,
            Message = Model.Message ?? "",
            Date = DateTime.Now
        };
        Pledges.Add(s);
        Submission = s;
        Submitted = true;
        Model = new SponsorshipModel(); // reset
        return Task.CompletedTask;
    }

    class SponsorshipModel
    {
        [Required] public string? Name { get; set; }
        [Range(1, 10000)] public decimal Amount { get; set; } = 50;
        public string? Message { get; set; }
    }

    class SponsorshipSubmission
    {
        public string Name { get; set; } = "";
        public decimal Amount { get; set; }
        public string Message { get; set; } = "";
        public DateTime Date { get; set; }
    }
}